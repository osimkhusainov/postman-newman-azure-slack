pool:
  name: Azure Pipelines
  demands: npm
  vmImage: 'ubuntu-latest'

steps:
  - powershell: |
      $BUILD_URL = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
      Write-Host "##vso[task.setvariable variable=BUILD_URL;]$BUILD_URL"
    displayName: 'Set build url variable'

  - task: Npm@1
    displayName: 'npm install'
    inputs:
      verbose: false

  - task: Npm@1
    displayName: 'npm run regression'
    condition: always()
    inputs:
      command: custom
      verbose: false
      workingDir: ./
      customCommand: 'run regression'
    env:
      TCS_C_API_KEY: ${TCS_C_API_KEY}
      TCS_E_API_KEY: ${TCS_E_API_KEY}
      COLLECTION_UID: ${COLLECTION_UID}
      QA_ENV_UID: ${QA_ENV_UID}
      BUILD_URL: ${BUILD_URL}
      ENV: 'QA'
      SLACK_QA_URL: ${SLACK_QA_URL}
      SLACK_CHANNEL: '#tcs-api-tests-qa-env'

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'result.xml'
      searchFolder: '$(system.defaultworkingdirectory)/junit'
      failTaskOnFailedTests: true
